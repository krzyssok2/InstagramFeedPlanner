@page "/planner"

<PageTitle>Planner</PageTitle>

@if (FeedService?.SelectedFeed?.Posts != null)
{
    <div class="planner-wrapper">
        <div class="feed-selector">
            <button @onclick="() => AddNewFeed()">Add new Feed</button>
            <br />

            <div class="feed-list">
                @foreach (var feed in FeedService.Feeds)
                {
                    <div class="feed-option @(SelectedFeedId == feed.Id ? "selected" : "")"
                         @onclick="() => SelectFeed(feed.Id)">
                        <span>@feed.Name</span>
                        <button class="delete-feed-btn" @onclick="(e) => DeleteFeed(feed.Id)" @onclick:stopPropagation>
                            <XIcon StrokeThickness="2" />
                        </button>
                    </div>
                }
            </div>
        </div>

        <div class="planner-page">
            <button @onclick="() => AddEmptyPost()">Add</button>

            <div class="feed-grid">
                @foreach (var post in FeedService.SelectedFeed.Posts.OrderByDescending(e => e.Position))
                {
                    <div @key="post.Id"
                         class="feed-item"
                         ondragover="event.preventDefault();"
                         draggable="@(post.IsLocked ? "false" : "true")"
                         @ondragstart="() => OnDragStart(post.Id)"
                         @ondrop="(e) => OnDrop(post.Id, e)">

                        @if (!post.IsLocked)
                        {
                            <button class="delete-button" @onclick="() => OnPostDelete(post.Id)" @onclick:stopPropagation>
                                <XIcon StrokeThickness="4" />
                            </button>
                        }

                        <button class="icon-button" @onclick="() => OnLock(post.Id)" @onclick:stopPropagation>
                            @if (post.IsLocked)
                            {
                                <PaddleLocked StrokeThickness="2" />
                            }
                            else
                            {
                                <PaddleUnlocked StrokeThickness="2" />
                            }
                        </button>

                        @if (!post.IsLocked && !string.IsNullOrEmpty(post.Url))
                        {
                            <button class="icon-button" style="margin-top: 32px;" @onclick="() => OnAdjust(post)" @onclick:stopPropagation>
                                <Wrench StrokeThickness="2" />
                            </button>
                        }

                        @if (!string.IsNullOrEmpty(post.Url))
                        {
                            <img src="@post.Url" style="@GetCropStyle(post.CropData)" draggable="@(post.IsLocked ? "false" : "true")" />
                        }

                    </div>
                }
            </div>
        </div>
    </div>
}
else
{
    <h1>Loading</h1>
}


@if (adjustingElement != null)
{
    <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:1000;">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:10px; aspect-ratio:4/5; width:90vw; max-width:500px; height:auto;">
            <AspectCropper Src="@adjustingElement.Url" OnConfirm="@(result => OnCropConfirmed(result))" CropData="@adjustingElement.CropData.ToCropDataModel()" />
            <button @onclick="CancelAdjust">Cancel</button>
        </div>
    </div>
}

<style>
    .planner-wrapper {
        display: flex;
        height: var(--full-page-height);
    }

    /* Left column */
    .feed-selector {
        width: 250px;
        border-right: 1px solid #ccc;
        padding: 10px;
        overflow-y: auto;
    }

    .feed-list {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .feed-option {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 10px;
        border: 1px solid transparent;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }

        .feed-option:hover {
            background: #f5f5f5;
        }

        /* Glowing selected feed */
        .feed-option.selected {
            border: 1px solid #007bff;
            box-shadow: 0 0 8px #007bff;
            background: #eef6ff;
        }

    /* Delete button for feeds */
    .delete-feed-btn {
        border: none;
        background: transparent;
        cursor: pointer;
        padding: 2px;
        display: flex;
        align-items: center;
    }

    .delete-button {
        position: absolute;
        top: 0px; /* adjust as needed */
        right: 0px; /* adjust as needed */
        margin-left: auto;
        border-width: 2px;
        height: 32px;
        width: 32px;
        padding: 0px;
        cursor: pointer;
        transition: 0.2s ease-in-out;
        z-index: 1;
    }

    .icon-button {
        position: absolute;
        top: 0px; /* adjust as needed */
        left: 0px; /* adjust as needed */
        margin-left: auto;
        border-width: 2px;
        height: 32px;
        width: 32px;
        padding: 0px;
        cursor: pointer;
        transition: 0.2s ease-in-out;
        z-index: 1;
    }

    .planner-page {
        border: 1px solid;
        height: 100%;
        width:100%;
        overflow-x: hidden;
        overflow-y: scroll;
        max-height: var(--full-page-height);
    }

    .feed-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1px;
        max-width: 972px;
        margin: 0 auto;
        user-select: none;
        -webkit-user-select: none; /* Safari */
        -ms-user-select: none; /* old IE/Edge */
    }

    .feed-item {
        aspect-ratio: 4 / 5;
        width: 324px; /* fill grid cell */
        height: 405px; /* allow height to be automatic */
        background: gray;
        max-width: 324px;
        max-height: 405px;
        position: relative;
        overflow: clip;
    }
</style>

<script>
    window.visibilityHandler = {
        register: function (dotNetHelper) {
            document.addEventListener("visibilitychange", () => {
                dotNetHelper.invokeMethodAsync("OnVisibilityChanged", !document.hidden);
            });
        }
    };

    (function () {
        let lastDropEvent = null;

        document.addEventListener('drop', function (ev) {
            ev.preventDefault();
            lastDropEvent = ev;
        }, true);

        document.addEventListener('dragover', function (ev) {
            ev.preventDefault();
        }, true);

        window.dragDropHelper = {
            getImageFromDropEvent: function () {
                return new Promise((resolve) => {
                    let e = lastDropEvent;
                    lastDropEvent = null;

                    if (!e || !e.dataTransfer || !e.dataTransfer.files || e.dataTransfer.files.length === 0) {
                        resolve("");
                        return;
                    }

                    var file = e.dataTransfer.files[0];
                    var isImage = file.type.startsWith('image/') || ['jpg','jpeg','png','webp']
                            .includes(file.name.split('.').pop().toLowerCase());

                    if (isImage) {
                        var reader = new FileReader();
                        reader.onload = function (evt) {
                            resolve(evt.target.result);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        resolve("");
                    }
                });
            },
        };
    })();
</script>