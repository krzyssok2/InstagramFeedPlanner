@using InstagramFeedPlanner.Components

@page "/planner"

<PageTitle>Planner</PageTitle>

@inject IJSRuntime JS

<button @onclick="() => AddElement()">Add</button>

<div class="planner-page">
    <div class="feed-grid">
        @foreach (var element in Images)
        {
            <div class="feed-item"
                 ondragover="event.preventDefault();"
                 style="background: #4d4d4d; aspect-ratio:4/5; width:100%; height:auto; overflow:hidden; position:relative;"
                 draggable="true"
                 @ondragstart="(e) => OnDragStart(element, e)"
                 @ondrop="(e) => OnDrop(element, e)">
                 <div>
                    <button class="delete-button" @onclick="() => OnDelete(element)" @onclick:stopPropagation>
                        Delete
                    </button>
                    <button class="delete-button" style="color:blue;right:30px;" @onclick="() => OnAdjust(element)" @onclick:stopPropagation>
                        Adjust
                    </button>
                 </div>
                
                 @if (!string.IsNullOrEmpty(element.Url))
                 {
                     <img src="@element.Url" style="@GetCropStyle(element.CropData)" />
                 }
            </div>
        }
    </div>
</div>

@if (adjustingElement != null)
{
    <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:1000;">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:10px; aspect-ratio:4/5; width:90vw; max-width:500px; height:auto;">
            <InstagramFeedPlanner.Components.AspectCropper2 Src="@adjustingElement.Url" OnConfirm="@(result => OnCropConfirmed(result))" CropData="@adjustingElement.CropData" />
            <button @onclick="CancelAdjust" style="margin-top:10px;">Cancel</button>
        </div>
    </div>
}

@code {
    private class InstagramElement
    {
        public string Url { get; set; } // Only original image
        public CropData CropData { get; set; } = new CropData();
    }

    private void AddElement()
    {
        Images.Add(new InstagramElement());            
    }

    private List<InstagramElement> Images = new()
    {
    };

    InstagramElement? draggedItem;
    InstagramElement? adjustingElement;

    void OnDelete(InstagramElement element)
    {
        var index = Images.IndexOf(element);
        Images.RemoveAt(index);
    }

    void OnAdjust(InstagramElement element)
    {
        adjustingElement = element;
    }

    void CancelAdjust()
    {
        adjustingElement = null;
    }

    async Task OnCropConfirmed((string _, CropData cropData) result)
    {
        if (adjustingElement != null)
        {
            adjustingElement.CropData = result.cropData;
            adjustingElement = null;
            StateHasChanged();
        }
    }

    void OnDragStart(InstagramElement element, DragEventArgs e)
    {
        draggedItem = element;
    }

    async Task OnDrop(InstagramElement element, DragEventArgs e)
    {
        if (draggedItem != null)
        {
            if(e.ShiftKey)
            {
                HandleSwap(Images, draggedItem, element, e);
            }
            else
            {
                HandleInsert(Images, draggedItem, element, e);
            }     
            draggedItem = null;
            StateHasChanged();
            return;
        }
        // Image drop logic
        var imageUrl = await JS.InvokeAsync<string>("dragDropHelper.getImageFromDropEvent");
        if (!string.IsNullOrEmpty(imageUrl))
        {
            element.Url = imageUrl;
            element.CropData = new CropData();
            StateHasChanged();
        }
    }

    private void HandleInsert(List<InstagramElement> currentFeed, InstagramElement draggedItem, InstagramElement element, DragEventArgs e)
    {
        var draggedIndex = currentFeed.IndexOf(draggedItem);
        var dropIndex = currentFeed.IndexOf(element);
        if (draggedIndex != dropIndex)
        {
            // Remove dragged item
            currentFeed.RemoveAt(draggedIndex);
            currentFeed.Insert(dropIndex, draggedItem);
        }
    }

    private void HandleSwap(List<InstagramElement> currentFeed, InstagramElement draggedItem, InstagramElement element, DragEventArgs e)
    {
        var draggedIndex = currentFeed.IndexOf(draggedItem);
        var dropIndex = currentFeed.IndexOf(element);
        (currentFeed[draggedIndex], currentFeed[dropIndex]) = (currentFeed[dropIndex], currentFeed[draggedIndex]);
    }

    private string GetCropStyle(CropData crop)
    {
        if (crop == null || crop.Scale == 0 || crop.ImgWidth == 0 || crop.ImgHeight == 0)
            return "width:100%;height:100%;left:0;top:0;position:absolute;";
        var scaledWidth = crop.ImgWidth * crop.Scale;
        var scaledHeight = crop.ImgHeight * crop.Scale;
        var left = crop.PosX;
        var top = crop.PosY;
        return $"width:{scaledWidth}px;height:{scaledHeight}px;left:{left}px;top:{top}px;position:absolute;";
    }
}

<style>
    .delete-button {
        position: absolute;
        top: 1px; /* adjust as needed */
        right: 1px; /* adjust as needed */
        background: transparent !important;
        margin-left: auto;
        border: none;
        color: red !important;
        cursor: pointer;
        transition: 0.2s ease-in-out;
        z-index:1000;
    }

        .delete-button:hover {
            background-color: transparent;
            transform: scale(1.3);
            opacity: 0.8;
        }

    .planner-page {
        border: 1px solid;        
        height: var(--full-page-height);
        overflow-x: hidden;
        overflow-y:scroll;
        max-height: var(--full-page-height);
    }

    .feed-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .feed-item {
        aspect-ratio: 4 / 5; /* keep shape */
        width: 400px; /* fill grid cell */
        height: 500px; /* allow height to be automatic */
        position: relative;
        overflow: hidden;
    }
</style>

<script>
    (function () {
        let lastDropEvent = null;

        document.addEventListener('drop', function (ev) {
            ev.preventDefault();
            lastDropEvent = ev;
        }, true);

        document.addEventListener('dragover', function (ev) {
            ev.preventDefault();
        }, true);

        window.dragDropHelper = {
            getImageFromDropEvent: function () {
                return new Promise((resolve) => {
                    let e = lastDropEvent;
                    lastDropEvent = null;

                    if (!e || !e.dataTransfer || !e.dataTransfer.files || e.dataTransfer.files.length === 0) {
                        resolve("");
                        return;
                    }

                    var file = e.dataTransfer.files[0];
                    var isImage = file.type.startsWith('image/') || ['jpg','jpeg','png','gif','bmp','webp']
                            .includes(file.name.split('.').pop().toLowerCase());

                    if (isImage) {
                        var reader = new FileReader();
                        reader.onload = function (evt) {
                            resolve(evt.target.result);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        resolve("");
                    }
                });
            },
        };
    })();
</script>